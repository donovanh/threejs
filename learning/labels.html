<html>
  <head>
    <title>Multiple frames</title>
    <style>
      body {
        margin: 0;
        font-family: Helvetica, Arial, Sans-serif;
      }
      canvas { width: 100%; height: 100% }
      .count {
        width: 64px;
        height: 50px;
        background: #aaa;
        color: #333;
        text-align: center;
        line-height: 50px;
        font-size: 32px;
        position: absolute;
        bottom: 0;
        right: 0;
      }
    </style>
  </head>
  <body>

    <div class="count" id="frame-count">0</div>
    <!-- The main Three JS -->
    <script src="js/three.min.js"></script>
    <!-- Extra library stuff -->
    <script src="js/OrbitControls.js"></script>
    <script src="js/tween.min.js"></script>
    <script src="js/dat.gui.min.js"></script>
    <!-- Custom code -->
    <script src="js/frameData.js"></script>
    <script>
      /*
        Note: Frames 65 73 107 are dodgy

        "frameData" defined in frames.js as:
        var frameData = [
          [
            {
              x: 0.2159058,
              y: -0.5400928,
              z: 3.537689
            },
            ... for all points in the frame
          ],
          [
          ... for all frames in the animation

        ];

        // Labels
        0 = Hip center
        1 = Chest center
        2 = Chin
        3 = Head
        4 = Right shoulder
        5 = Right elbow
        6 = Right wrist
        7 = Right hand
        8 = Left shoulder
        9 = Left elbow
        10 = Left wrist
        11 = Left hand
        12 = Right hip
        13 = Right knee
        14 = Right ankle
        15 = Right foot
        16 = Left hips
        17 = Left knee
        18 = Left ankle
        19 = Left foot
        20 = Collar bone
        21 = Right fingers (1)
        22 = Right fingers (2)
        23 = Left fingers (1)
        24 = Left fingers (2)

        TODO: Add these as labels in labels.html

      */
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );
      settings = {
        frameDelay: 33
      }

      var gui = new dat.GUI();
      gui.add(settings, 'frameDelay', 10, 2000);

      controls = new THREE.OrbitControls ( camera );
      controls.addEventListener('change', render);

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      // Loop through the frameData array and add the points
      firstFrame = frameData[0];
      firstFrame.forEach(function(point, index, arr) {
        var geometry = new THREE.SphereGeometry( 0.2, 10, 10 );
        if (index === 15 || index === 19 || index === 11 || index === 7 || index > 20) {
          var material = new THREE.MeshBasicMaterial( { transparent: true, opacity: 0 } );
        } else {
          var material = new THREE.MeshPhongMaterial( { color: 0x00ff00 } );
        }
        var cube = new THREE.Mesh( geometry, material );
        cube.position.x = point.x * 10;
        cube.position.y = point.y * 10;
        cube.position.z = point.z;
        cube.castShadow = true;
        cube.name = "cube" + index;
        scene.add( cube );
      });

      // Loop through all the frames and update the coordinates of each point
      currentFrame = 1;
      setTimeout(function() { updateFrame() }, settings.frameDelay);
      // TODO: Remove setInterval and set up a loop that builds a chain of tweens
      // Reference: https://github.com/tweenjs/tween.js/blob/master/docs/user_guide.md#chain

      var updateFrame = function() {
        // Update onscreen frame count
        document.getElementById("frame-count").innerHTML = currentFrame;

        var currentFrameData = frameData[currentFrame];
        currentFrameData.forEach(function(point, index, arr) {
          var cube = scene.getObjectByName( "cube" + index );
          var position = { x : cube.position.x, y: cube.position.y, z: cube.position.z };
          var target = { x : point.x * 10, y: point.y * 10, z: point.z };
          var tween = new TWEEN.Tween(position)
            .to(target, settings.frameDelay)
            .onUpdate(function(){
              cube.position.x = position.x;
              cube.position.y = position.y;
              cube.position.z = position.z;
            })
            .easing(TWEEN.Easing.Linear.None)
            .start();

        });
        if (currentFrame == frameData.length - 1) {
          currentFrame = 0;
        } else {
          currentFrame ++;
        }

        // Call another frame draw depending on delay time
        setTimeout(function() { updateFrame() }, settings.frameDelay);
      };

      // Lights
      var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.25 );
      directionalLight.position.set( 0, 1, 0 );
      directionalLight.castShadow = true;
      scene.add( directionalLight );

      var spotLight = new THREE.SpotLight( 0xffffff );
      spotLight.position.set( 0, 1000, 100 );
      spotLight.rotateX(-0.8)

      spotLight.castShadow = true;

      spotLight.shadowMapWidth = 1024;
      spotLight.shadowMapHeight = 1024;

      spotLight.shadowCameraNear = 500;
      spotLight.shadowCameraFar = 4000;
      spotLight.shadowCameraFov = 30;

      scene.add( spotLight );

      // Camera
      camera.position.x = 2;
      camera.position.y = -4;
      camera.position.z = 30;

      // Floor
      var geometry = new THREE.PlaneGeometry( 1000, 1000, 1, 1 );
      var material = new THREE.MeshLambertMaterial({ color: 0x111111 } );
      var floor = new THREE.Mesh( geometry, material );
      floor.material.side = THREE.DoubleSide;
      floor.position.y = -15;
      floor.rotateX(-1.57079633);
      scene.add( floor );



      var render = function () {
        TWEEN.update();
        requestAnimationFrame( render );
        renderer.setClearColor( 0x222222, 1);
        renderer.render(scene, camera);
      };

      render();
    </script>
  </body>
</html>
